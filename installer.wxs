<?xml version='1.0' encoding='windows-1252'?>
<Wix xmlns='http://schemas.microsoft.com/wix/2006/wi' xmlns:difx='http://schemas.microsoft.com/wix/DifxAppExtension' xmlns:iis='http://schemas.microsoft.com/wix/IIsExtension'>
  <?if $(env._BUILDARCH) = x86 ?>
    <?define ARCHDIR = i386 ?>
    <?define PFILESDIR = ProgramFilesFolder ?>
  <?elseif $(env._BUILDARCH) = AMD64 ?>
    <?define ARCHDIR = amd64 ?>
    <?define PFILESDIR = ProgramFiles64Folder ?>
  <?endif ?>

  <Module Id='vmmXenWindowsPvdrivers'
    Language='1033' Codepage='1252' Version='$(env.GPLPV_VERSION)'>

    <Package Id='{8DE1EC6D-0E61-4849-AB6C-1C3BD557C58E}' Keywords='Installer' Description="GPL PV Drivers for Windows"
      Comments='no comment' Manufacturer='James Harper' InstallScope='perMachine'
      InstallerVersion='200' InstallPrivileges="elevated" Languages='1033'
      SummaryCodepage='1252' />

    <WixVariable Id="WixUILicenseRtf" Value="license.rtf" />

    <?if $(env.DDK_TARGET_OS) != Win2K?>
    <Binary Id='waitfordevices.vbs' SourceFile='waitnopendinginstallevents\waitfordevices.vbs'/>
    <Binary Id='waitnopendinst.exe' SourceFile='waitnopendinginstallevents\obj$(env.BUILD_ALT_DIR)\$(var.ARCHDIR)\waitnopendinginstallevents.exe'/>
    <?endif?>
    <CustomAction Id='UnInstallOldService' FileKey='shutdownmon.exe' ExeCommand='-u' Execute='deferred' Return='check' Impersonate='no'/>
    <?if $(env.DDK_TARGET_OS) != Win2K ?>
    <CustomAction Id='WaitForDevices' BinaryKey='waitfordevices.vbs' VBScriptCall='DoWaitForDevices' Execute='deferred' Return='check' Impersonate='no'/>
    <CustomAction Id='WaitNoPendingInstallEvents' BinaryKey='waitnopendinst.exe' ExeCommand='300000' Execute='deferred' Return='check' Impersonate='no'/>
    <CustomAction Id='CopyConfig' FileKey='copyconfig.exe' ExeCommand='' Execute='deferred' Return='check' Impersonate='no'/>
    <?endif?>

    <Property Id="SYSTEMSTARTOPTIONS">
      <RegistrySearch Id="SystemStartOptions"
		    Root="HKLM"
		    Key="SYSTEM\CurrentControlSet\Control"
		    Name="SystemStartOptions"
		    Type="raw" />
    </Property>

    <Directory Id='TARGETDIR' Name='SourceDir'>
      <Directory Id='$(var.PFILESDIR)'>
        <Directory Id='XenProgramFilesDir' Name='Xen PV Drivers'>
          <Directory Id='BinDir' Name='bin'>
            <Component Id='ShutdownMon' Guid='BF8DC887-4B46-4e77-ACD3-125E8A2BAB8E'>
              <File Id='shutdownmon.exe' Name='shutdownmon.exe' DiskId='1' Source='shutdownmon\obj$(env.BUILD_ALT_DIR)\$(var.ARCHDIR)\shutdownmon.exe' />
              <ServiceInstall
              Id="ServiceInstaller"
              Type="ownProcess"
              Vital="no"
              Name="ShutdownMon"
              Arguments="-s"
              DisplayName="Xen Shutdown Monitor"
              Description="Xen Shutdown Monitor"
              Start="auto"
              Account="LocalSystem"
              ErrorControl="ignore"
              Interactive="no"
              />
              <ServiceControl Id="StartService" Remove="uninstall" Name="ShutdownMon" Wait="no" />
            </Component>
            <?if $(env.DDK_TARGET_OS) != Win2K ?>
            <Component Id='CopyConfig' Guid='C01F8A97-1410-41ce-A16E-76E6072FDFF8'>
              <File Id='copyconfig.exe' Name='copyconfig.exe' DiskId='1' Source='copyconfig\obj$(env.BUILD_ALT_DIR)\$(var.ARCHDIR)\copyconfig.exe' />
            </Component>
            <?endif ?>
          </Directory>
          <Directory Id='DocDir' Name='doc'>
            <Component Id='Docs' Guid='C827FAD8-F459-42bf-9F77-921E04261B72'>
              <File Id='Changelog.txt' Name='Changelog.txt' DiskId='1' Source='Changelog.txt' />
            </Component>
          </Directory>
          <Directory Id='DriversDir' Name='drivers'>
            <Directory Id='XenPciDir' Name='xenpci'>
              <Component Id='XenPci' Guid='D6BB9B5F-61F9-4b6e-8FAD-289706F5EBEB'>
                <File Id='xenpci.cat' Name='xenpci.cat' DiskId='1' Source='xenpci\obj$(env.BUILD_ALT_DIR)\$(var.ARCHDIR)\xenpci.cat' />
                <File Id='xenpci.inf' Name='xenpci.inf' DiskId='1' Source='xenpci\obj$(env.BUILD_ALT_DIR)\$(var.ARCHDIR)\xenpci.inf' />
                <File Id='xenpci.sys' Name='xenpci.sys' DiskId='1' Source='xenpci\obj$(env.BUILD_ALT_DIR)\$(var.ARCHDIR)\xenpci.sys' />
                <File Id='$(env.WDFFILENAME)' Name='$(env.WDFFILENAME)' DiskId='1' Source='xenpci\obj$(env.BUILD_ALT_DIR)\$(var.ARCHDIR)\$(env.WDFFILENAME)' />
                <difx:Driver Sequence='99' Legacy='yes' PlugAndPlayPrompt='no' ForceInstall='yes' AddRemovePrograms='no'/>
              </Component>
            </Directory>
            <Directory Id='XenVbdDir' Name='xenvbd'>
              <Component Id='XenVbd' Guid='1F05DC54-974C-40f6-BF41-0EFDB3EBD1DC'>
                <File Id='xenvbd.cat' Name='xenvbd.cat' DiskId='1' Source='xenvbd\obj$(env.BUILD_ALT_DIR)\$(var.ARCHDIR)\xenvbd.cat' />
                <File Id='xenvbd.inf' Name='xenvbd.inf' DiskId='1' Source='xenvbd\obj$(env.BUILD_ALT_DIR)\$(var.ARCHDIR)\xenvbd.inf' />
                <File Id='xenvbd.sys' Name='xenvbd.sys' DiskId='1' Source='xenvbd\obj$(env.BUILD_ALT_DIR)\$(var.ARCHDIR)\xenvbd.sys' />
                <difx:Driver Sequence='1' Legacy='yes' PlugAndPlayPrompt='no' ForceInstall='yes' AddRemovePrograms='no'/>
              </Component>
            </Directory>
            <?if $(env.DDK_TARGET_OS) != Win2K ?>
            <Directory Id='XenScsiDir' Name='xenscsi'>
              <Component Id='XenScsi' Guid='47C9AB48-3A7D-42b2-AE2C-7F9235C8B7B4'>
                <File Id='xenscsi.cat' Name='xenscsi.cat' DiskId='1' Source='xenscsi\obj$(env.BUILD_ALT_DIR)\$(var.ARCHDIR)\xenscsi.cat' />
                <File Id='xenscsi.inf' Name='xenscsi.inf' DiskId='1' Source='xenscsi\obj$(env.BUILD_ALT_DIR)\$(var.ARCHDIR)\xenscsi.inf' />
                <File Id='xenscsi.sys' Name='xenscsi.sys' DiskId='1' Source='xenscsi\obj$(env.BUILD_ALT_DIR)\$(var.ARCHDIR)\xenscsi.sys' />
                <difx:Driver Sequence='2' Legacy='yes' PlugAndPlayPrompt='no' ForceInstall='yes' AddRemovePrograms='no'/>
              </Component>
            </Directory>
            <?endif ?>
            <Directory Id='XenNetDir' Name='xennet'>
              <Component Id='XenNet' Guid='F16B1EC7-35B1-42c2-9017-22DC23D80BE7'>
                <File Id='xennet.cat' Name='xennet.cat' DiskId='1' Source='xennet\obj$(env.BUILD_ALT_DIR)\$(var.ARCHDIR)\xennet.cat' />
                <File Id='xennet.inf' Name='xennet.inf' DiskId='1' Source='xennet\obj$(env.BUILD_ALT_DIR)\$(var.ARCHDIR)\xennet.inf' />
                <File Id='xennet.sys' Name='xennet.sys' DiskId='1' Source='xennet\obj$(env.BUILD_ALT_DIR)\$(var.ARCHDIR)\xennet.sys' />
                <difx:Driver Sequence='3' Legacy='yes' PlugAndPlayPrompt='no' ForceInstall='yes' AddRemovePrograms='no'/>
              </Component>
            </Directory>
            <?if $(env.DDK_TARGET_OS) != Win2K ?>
            <Directory Id='XenUsbDir' Name='xenusb'>
              <Component Id='XenUsb' Guid='83746E68-DBCC-4feb-B521-09D5328D3BB0'>
                <File Id='xenusb.cat' Name='xenusb.cat' DiskId='1' Source='xenusb\obj$(env.BUILD_ALT_DIR)\$(var.ARCHDIR)\xenusb.cat' />
                <File Id='xenusb.inf' Name='xenusb.inf' DiskId='1' Source='xenusb\obj$(env.BUILD_ALT_DIR)\$(var.ARCHDIR)\xenusb.inf' />
                <File Id='xenusb.sys' Name='xenusb.sys' DiskId='1' Source='xenusb\obj$(env.BUILD_ALT_DIR)\$(var.ARCHDIR)\xenusb.sys' />
                <!-- we deliberately use the file from xenpci so that wix can deduplicate it -->
                <File Id='$(env.WDFFILENAME)_usb' Name='$(env.WDFFILENAME)' DiskId='1' Source='xenpci\obj$(env.BUILD_ALT_DIR)\$(var.ARCHDIR)\$(env.WDFFILENAME)' />
                <difx:Driver Sequence='3' Legacy='yes' PlugAndPlayPrompt='no' ForceInstall='yes' AddRemovePrograms='no'/>
              </Component>
            </Directory>
            <?endif ?>
          </Directory>
        </Directory>
        <?ifdef env.CERT_PUBLIC_FILENAME?>
        <Component Id='Cert' Guid='11112EC8-8635-45fb-9AE8-C22310F1E82D'>
          <File Id='xen_pvdrivers_cert' Name='xen_pvdrivers_cert' DiskId='1' Source='$(env.CERT_PUBLIC_FILENAME)' />
          <iis:Certificate Id='xen_pvdrivers_cert_root' Name='xen_pvdrivers_cert' Request='no' BinaryKey='xen_pvdrivers_cert' StoreLocation='localMachine' StoreName='root' Overwrite='no' />
          <iis:Certificate Id='xen_pvdrivers_cert_trustedPublisher' Name='xen_pvdrivers_cert' Request='no' BinaryKey='xen_pvdrivers_cert' StoreLocation='localMachine' StoreName='trustedPublisher' Overwrite='no' />
        </Component>
        <?endif ?>
      </Directory>
      <Directory Id='SystemFolder'>
        <Component Id='XenVchan' Guid='d557155e-0d78-4ae6-8fe1-b5d2fba733a7'>
          <File Id='libxenvchan.dll' Name='libxenvchan.dll' DiskId='1' Source='tools\libs\$(var.ARCHDIR)\libxenvchan.dll'/>
        </Component>
      </Directory>
    </Directory>

    <?ifdef env.CERT_PUBLIC_FILENAME?>
    <Binary Id='xen_pvdrivers_cert' SourceFile='$(env.CERT_PUBLIC_FILENAME)' />
    <?endif ?>

    <InstallExecuteSequence>
      <ScheduleReboot  Sequence='7000'/>
      <?ifdef env.CERT_PUBLIC_FILENAME?>
      <Custom Action="InstallCertificates" Before='MsiProcessDrivers' />
      <?endif ?>
      <Custom Action='UnInstallOldService' Before='InstallServices'>NOT Installed</Custom>
      <?if $(env.DDK_TARGET_OS) != Win2K ?>
      <Custom Action='WaitForDevices' After='MsiProcessDrivers'>1</Custom>
      <Custom Action='WaitNoPendingInstallEvents' After='WaitForDevices'>1</Custom>
      <Custom Action='CopyConfig' After='WaitNoPendingInstallEvents'>$CopyConfig>2</Custom>
      <?endif?>
    </InstallExecuteSequence>
  </Module>
</Wix>
